---
phase: 01-foundation-compliance
plan: 05
type: execute
wave: 5
depends_on: ["01-01"]
files_modified:
  - /var/www/campaign-site/
  - /etc/nginx/sites-available/campaign-site
  - /etc/nginx/sites-enabled/campaign-site
  - /home/deploy-user/deploy.sh
autonomous: false
user_setup:
  - service: digitalocean-droplet
    why: "Static site deployment hosting on VPS"
    prerequisites:
      - "DigitalOcean Droplet with Ubuntu (20.04 or 22.04)"
      - "SSH access to the Droplet (root or sudo user)"
      - "Domain name pointed to Droplet IP (optional)"
    ssh_access:
      - "SSH into Droplet: ssh root@your-droplet-ip"
      - "Or use SSH key: ssh -i ~/.ssh/your-key root@your-droplet-ip"
    manual_steps:
      - task: "Configure DNS"
        location: "Domain registrar -> DNS Settings"
        instructions: "Add A record pointing domain to Droplet IP"
      - task: "Set up deployment user (recommended)"
        location: "Droplet terminal"
        instructions: "Create non-root user with sudo privileges for deployments"

must_haves:
  truths:
    - "Site can be built with npm run generate"
    - ".output/public/ directory contains index.html and _nuxt/ assets"
    - "Nginx can serve static files from a directory"
    - "SSH access allows remote command execution"
    - "GitHub repo can be cloned via SSH or HTTPS"
  artifacts:
    - path: "/var/www/campaign-site/"
      provides: "Deployed static site files"
      contains: "index.html, _nuxt/"
    - path: "/etc/nginx/sites-available/campaign-site"
      provides: "Nginx virtual host configuration"
      contains: "server_name, root, location blocks"
    - path: "/home/deploy-user/deploy.sh"
      provides: "Simple deployment script"
      contains: "git pull, npm install, npm run generate, nginx reload"
  key_links:
    - from: "GitHub repository"
      to: "/var/www/campaign-site/"
      via: "git clone"
      pattern: "git.*clone.*github"
    - from: "/var/www/campaign-site/.output/public/"
      to: "Public internet"
      via: "Nginx static file serving"
      pattern: "root.*output/public"

---

<objective>
Configure DigitalOcean Droplet with Nginx to serve static Nuxt 4 site, with a simple deployment process for updates.

Purpose: The site needs to be deployed to a public URL for testing and production use. A DigitalOcean Droplet provides a cost-effective VPS option with full control over the server configuration. Nginx will serve the pre-generated static files with excellent performance.

Output: Droplet configured with Node.js, Nginx serving the static site, and a simple deployment script for updates.
</objective>

<execution_context>
@/home/deck/.claude/get-shit-done/workflows/execute-plan.md
@/home/deck/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-foundation-compliance/01-RESEARCH.md
@.planning/phases/01-foundation-compliance/01-01-PLAN.md
@.planning/phases/01-foundation-compliance/01-04-PLAN.md
</context>

<tasks>

<task type="checkpoint:human-action" gate="blocking">
  <name>Connect to Droplet and prepare system</name>
  <what-built>None (initial setup)</what-built>
  <how-to-verify>
    Before proceeding, ensure you have:

    1. **SSH Access to Droplet:**
       ```bash
       ssh root@your-droplet-ip
       # or with key:
       ssh -i ~/.ssh/your-key root@your-droplet-ip
       ```

    2. **Verify Ubuntu Version:**
       ```bash
       lsb_release -a
       # Should show Ubuntu 20.04 or 22.04
       ```

    3. **Update System (recommended):**
       ```bash
       apt update && apt upgrade -y
       ```

    4. **Note Your Droplet IP Address:**
       ```bash
       curl -4 ifconfig.co
       # or
       ip addr show eth0 | grep inet
       ```

    Once connected and verified, type "connected" to proceed.
  </how-to-verify>
  <resume-signal>Type "connected" when you have SSH access to the Droplet</resume-signal>
</task>

<task type="checkpoint:human-action" gate="blocking">
  <name>Install Node.js and npm on Droplet</name>
  <what-built>Node.js runtime and npm package manager</what-built>
  <how-to-verify>
    Run the following commands on your Droplet:

    1. **Install Node.js 20 (using NodeSource repository):**
       ```bash
       curl -fsSL https://deb.nodesource.com/setup_20.x | bash -
       apt install -y nodejs
       ```

    2. **Verify Installation:**
       ```bash
       node --version
       # Should output: v20.x.x
       npm --version
       # Should output: 10.x.x
       ```

    3. **Install PM2 (optional, for process management - not needed for static but useful):**
       ```bash
       npm install -g pm2
       ```

    Alternative: Use NVM for version flexibility:
    ```bash
    curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.7/install.sh | bash
    source ~/.bashrc
    nvm install 20
    nvm use 20
    nvm alias default 20
    ```

    Type "node-installed" when Node.js 20 is installed.
  </how-to-verify>
  <resume-signal>Type "node-installed" when Node.js and npm are installed</resume-signal>
</task>

<task type="checkpoint:human-action" gate="blocking">
  <name>Install and configure Nginx</name>
  <what-built>Nginx web server</what-built>
  <how-to-verify>
    Run the following commands on your Droplet:

    1. **Install Nginx:**
       ```bash
       apt install -y nginx
       ```

    2. **Start and Enable Nginx:**
       ```bash
       systemctl start nginx
       systemctl enable nginx
       ```

    3. **Verify Nginx is Running:**
       ```bash
       systemctl status nginx
       # Should show "active (running)"
       ```

    4. **Test Default Page:**
       Visit http://your-droplet-ip in a browser. You should see the Nginx welcome page.

    5. **Allow HTTP/HTTPS through Firewall (if UFW is enabled):**
       ```bash
       ufw allow 'Nginx Full'
       ufw status
       ```

    Type "nginx-installed" when Nginx is installed and running.
  </how-to-verify>
  <resume-signal>Type "nginx-installed" when Nginx is serving the default page</resume-signal>
</task>

<task type="checkpoint:human-action" gate="blocking">
  <name>Create deployment user and directory structure</name>
  <what-built>Deployment user with proper permissions</what-built>
  <how-to-verify>
    Run the following commands on your Droplet:

    1. **Create Deployment User (recommended for security):**
       ```bash
       adduser deploy-user
       # Set a secure password
       usermod -aG sudo deploy-user
       ```

    2. **Set up SSH for deploy-user (optional but recommended):**
       ```bash
       # As root, create .ssh directory for deploy-user
       mkdir -p /home/deploy-user/.ssh
       chmod 700 /home/deploy-user/.ssh

       # Copy your SSH public key (from your local machine):
       # On your LOCAL machine:
       cat ~/.ssh/id_rsa.pub
       # Copy the output

       # On the Droplet:
       nano /home/deploy-user/.ssh/authorized_keys
       # Paste your public key and save
       chmod 600 /home/deploy-user/.ssh/authorized_keys
       chown -R deploy-user:deploy-user /home/deploy-user/.ssh
       ```

    3. **Create Web Root Directory:**
       ```bash
       mkdir -p /var/www/campaign-site
       chown -R deploy-user:deploy-user /var/www/campaign-site
       chmod 755 /var/www/campaign-site
       ```

    4. **Switch to deploy-user for remaining tasks:**
       ```bash
       su - deploy-user
       # or exit and SSH back in as deploy-user
       ```

    Type "user-ready" when the deployment user is created and directory is set up.
  </how-to-verify>
  <resume-signal>Type "user-ready" when deployment user and directory are configured</resume-signal>
</task>

<task type="checkpoint:human-action" gate="blocking">
  <name>Clone GitHub repository to Droplet</name>
  <what-built>Repository cloned to /var/www/campaign-site</what-built>
  <how-to-verify>
    Run the following commands on your Droplet:

    1. **Configure Git (if not already configured):**
       ```bash
       git config --global user.name "Deploy User"
       git config --global user.email "deploy@campaign-site"
       ```

    2. **Clone the Repository:**
       ```bash
       cd /var/www
       # Using HTTPS (easier, but may require GitHub PAT for private repos):
       sudo -u deploy-user git clone https://github.com/alaw989/armstrong-campaign.git campaign-site

       # OR using SSH (requires SSH key setup on deploy-user):
       sudo -u deploy-user git clone git@github.com:alaw989/armstrong-campaign.git campaign-site
       ```

    3. **Verify Clone:**
       ```bash
       ls -la /var/www/campaign-site
       # Should see: .nuxt, .output, app, components, etc.
       ```

    4. **Navigate to Project Directory:**
       ```bash
       cd /var/www/campaign-site
       ```

    Type "cloned" when the repository is cloned to the Droplet.
  </how-to-verify>
  <resume-signal>Type "cloned" when repository is cloned to /var/www/campaign-site</resume-signal>
</task>

<task type="checkpoint:human-action" gate="blocking">
  <name>Build the static site on Droplet</name>
  <what-built>Built static files in .output/public/</what-built>
  <how-to-verify>
    Run the following commands on your Droplet:

    1. **Install Dependencies:**
       ```bash
       cd /var/www/campaign-site
       npm ci
       # npm ci is preferred for production (cleaner, faster)
       ```

    2. **Build Static Site:**
       ```bash
       npm run generate
       ```

    3. **Verify Output:**
       ```bash
       ls -la .output/public/
       # Should see: index.html, _nuxt/, and other static assets
       cat .output/public/index.html | head -20
       # Should see HTML content
       ```

    4. **Set Proper Permissions:**
       ```bash
       chmod -R 755 /var/www/campaign-site/.output/public
       chown -R deploy-user:www-data /var/www/campaign-site/.output/public
       ```

    Type "built" when the static site is successfully generated.
  </how-to-verify>
  <resume-signal>Type "built" when .output/public/ contains index.html</resume-signal>
</task>

<task type="checkpoint:human-action" gate="blocking">
  <name>Configure Nginx virtual host</name>
  <what-built>Nginx configuration for campaign-site</what-built>
  <how-to-verify>
    Create the Nginx configuration file on your Droplet:

    1. **Create Configuration File:**
       ```bash
       sudo nano /etc/nginx/sites-available/campaign-site
       ```

    2. **Add the Following Configuration:**

       ```nginx
       server {
           listen 80;
           listen [::]:80;

           server_name your-droplet-ip www.your-domain.com your-domain.com;

           # Redirect HTTP to HTTPS (uncomment after SSL is configured)
           # return 301 https://$server_name$request_uri;

           root /var/www/campaign-site/.output/public;
           index index.html;

           # Gzip compression
           gzip on;
           gzip_vary on;
           gzip_min_length 1024;
           gzip_types text/plain text/css text/xml text/javascript
                      application/x-javascript application/xml+rss
                      application/javascript application/json;

           # Cache static assets
           location ~* \.(js|css|png|jpg|jpeg|gif|svg|ico|woff|woff2|ttf|eot)$ {
               expires 1y;
               add_header Cache-Control "public, immutable";
           }

           # SPA fallback - try file first, then directory, then fallback to index.html
           location / {
               try_files $uri $uri/ /index.html;
           }

           # Security headers
           add_header X-Frame-Options "SAMEORIGIN" always;
           add_header X-Content-Type-Options "nosniff" always;
           add_header X-XSS-Protection "1; mode=block" always;

           # Nuxt assets
           location /_nuxt/ {
               try_files $uri =404;
           }
       }
       ```

    3. **Update server_name:**
       Replace `your-droplet-ip` with your actual Droplet IP
       Replace `your-domain.com` with your actual domain (if applicable)

    4. **Enable the Site:**
       ```bash
       sudo ln -s /etc/nginx/sites-available/campaign-site /etc/nginx/sites-enabled/
       ```

    5. **Remove Default Site (optional):**
       ```bash
       sudo rm /etc/nginx/sites-enabled/default
       ```

    6. **Test Nginx Configuration:**
       ```bash
       sudo nginx -t
       # Should show: "syntax is ok" and "test is successful"
       ```

    7. **Reload Nginx:**
       ```bash
       sudo systemctl reload nginx
       ```

    Type "nginx-configured" when Nginx is configured and reloaded.
  </how-to-verify>
  <resume-signal>Type "nginx-configured" when site is accessible via Droplet IP</resume-signal>
</task>

<task type="checkpoint:human-action" gate="blocking">
  <name>Verify site accessibility</name>
  <what-built>Deployed and accessible site</what-built>
  <how-to-verify>
    Verify the site is working:

    1. **Test via IP Address:**
       Open browser and visit: http://your-droplet-ip

    2. **Test via curl on Droplet:**
       ```bash
       curl -I http://localhost
       # Should return 200 OK
       ```

    3. **Check Nginx Access Logs:**
       ```bash
       sudo tail -f /var/log/nginx/access.log
       # Visit your site and watch for requests
       ```

    4. **Verify Static Assets are Loading:**
       - Check that styles are applied
       - Check that JavaScript is working
       - Check browser console for 404 errors

    5. **Common Issues:**
       - 403 Forbidden: Check permissions (755 on directories, 644 on files)
       - 404 Not Found: Check root path in Nginx config
       - Blank page: Check browser console, verify _nuxt/ assets are accessible

    Type "verified" when the site loads correctly in your browser.
  </how-to-verify>
  <resume-signal>Type "verified" when site is accessible and working correctly</resume-signal>
</task>

<task type="checkpoint:human-action" gate="blocking">
  <name>Create deployment script for updates</name>
  <what-built>Automated deployment script</what-built>
  <how-to-verify>
    Create a simple deployment script on the Droplet:

    1. **Create the Script:**
       ```bash
       nano /home/deploy-user/deploy.sh
       ```

    2. **Add the Following Content:**

       ```bash
       #!/bin/bash

       set -e  # Exit on any error

       echo "Starting deployment..."

       # Navigate to project directory
       cd /var/www/campaign-site

       # Pull latest changes from GitHub
       echo "Pulling latest changes..."
       git fetch origin
       git reset --hard origin/main  # or origin/master, check your branch name

       # Install dependencies
       echo "Installing dependencies..."
       npm ci

       # Build static site
       echo "Building static site..."
       npm run generate

       # Set permissions
       echo "Setting permissions..."
       chmod -R 755 .output/public
       chown -R deploy-user:www-data .output/public

       # Reload Nginx (not always needed for static updates, but safe)
       echo "Reloading Nginx..."
       sudo systemctl reload nginx

       echo "Deployment complete!"
       echo "Site accessible at: http://your-droplet-ip"
       ```

    3. **Make Script Executable:**
       ```bash
       chmod +x /home/deploy-user/deploy.sh
       ```

    4. **Test the Deployment Script:**
       ```bash
       /home/deploy-user/deploy.sh
       ```

    5. **Optional: Create Update Shortcut**
       ```bash
       echo 'alias deploy="/home/deploy-user/deploy.sh"' >> ~/.bashrc
       source ~/.bashrc
       # Now you can just type 'deploy' to update the site
       ```

    Type "script-ready" when the deployment script is created and tested.
  </how-to-verify>
  <resume-signal>Type "script-ready" when deployment script is working</resume-signal>
</task>

<task type="checkpoint:human-action" gate="non-blocking">
  <name>Configure SSL/HTTPS with Certbot (optional but recommended)</name>
  <what-built>HTTPS-enabled site with valid SSL certificate</what-built>
  <how-to-verify>
    To enable HTTPS, you need a domain name pointed to your Droplet:

    1. **Install Certbot:**
       ```bash
       sudo apt install -y certbot python3-certbot-nginx
       ```

    2. **Obtain SSL Certificate:**
       ```bash
       sudo certbot --nginx -d your-domain.com -d www.your-domain.com
       # Follow the prompts
       ```

    3. **Verify SSL:**
       - Visit https://your-domain.com
       - Check for the lock icon in browser

    4. **Verify Auto-Renewal:**
       ```bash
       sudo certbot renew --dry-run
       ```

    5. **Update Nginx Config for HTTPS (Certbot does this automatically):**
       The config will be updated with SSL settings.

    Note: Skip this task if you don't have a domain name yet.
    You can add SSL later.

    Type "ssl-configured" when HTTPS is working (or "skip" to skip).
  </how-to-verify>
  <resume-signal>Type "ssl-configured" when HTTPS is enabled or "skip" to skip</resume-signal>
</task>

<task type="checkpoint:human-action" gate="non-blocking">
  <name>Set up GitHub webhook for auto-deploy (optional)</name>
  <what-built>Automatic deployment on push to main branch</what-built>
  <how-to-verify>
    To automatically deploy when you push to GitHub:

    1. **Install a Webhook Handler (using webhook or a simple Node.js script):**

       Option A - Using webhook (simple):
       ```bash
       sudo apt install -y webhook
       ```

       Create webhook config:
       ```bash
       sudo nano /etc/webhook/hooks.json
       ```

       ```json
       [
         {
           "id": "deploy-site",
           "execute-command": "/home/deploy-user/deploy.sh",
           "command-working-directory": "/var/www/campaign-site",
           "response-message": "Deploying..."
         }
       ]
       ```

       Run webhook:
       ```bash
       sudo webhook -hooks /etc/webhook/hooks.json -verbose
       ```

       Create a systemd service for webhook:
       ```bash
       sudo nano /etc/systemd/system/webhook.service
       ```

       ```
       [Unit]
       Description=Webhook Server
       After=network.target

       [Service]
       ExecStart=/usr/bin/webhook -hooks /etc/webhook/hooks.json -verbose
       Restart=always

       [Install]
       WantedBy=multi-user.target
       ```

       ```bash
       sudo systemctl daemon-reload
       sudo systemctl enable webhook
       sudo systemctl start webhook
       ```

    2. **Configure GitHub Webhook:**
       - Go to your GitHub repo -> Settings -> Webhooks
       - Add webhook: https://your-domain.com:9000/hooks/deploy-site
       - Content type: application/json
       - Secret: (optional, set a secure token)
       - Events: Push events

    3. **Test the Webhook:**
       - Push a change to GitHub
       - Verify the site updates automatically

    Type "webhook-ready" when auto-deploy is working (or "skip" to skip).
  </how-to-verify>
  <resume-signal>Type "webhook-ready" when auto-deploy is configured or "skip"</resume-signal>
</task>

</tasks>

<verification>
1. On your local machine, open browser and visit http://your-droplet-ip
2. Verify the homepage loads correctly with styles and scripts
3. Check browser DevTools Network tab for any 404 errors
4. Run `sudo nginx -t` on Droplet to verify configuration is valid
5. Check `sudo systemctl status nginx` to verify Nginx is running
6. Test deployment script: push a change to GitHub, run `./deploy.sh`, verify change appears
</verification>

<success_criteria>
- Nginx is installed and running on the Droplet
- Site is accessible via Droplet IP address (or domain if configured)
- Static files in .output/public/ are being served correctly
- Deployment script at /home/deploy-user/deploy.sh successfully updates the site
- Site navigation works (SPA routing via try_files)
- (Optional) HTTPS/SSL is configured with Certbot
- (Optional) Auto-deploy webhook is configured
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-compliance/01-05-SUMMARY.md`

Summary should include:
- Droplet IP address and domain (if configured)
- Nginx configuration summary
- Deployment process documentation
- Any issues encountered and resolutions
</output>

---

## Quick Reference: Deployment Commands

```bash
# SSH into Droplet
ssh root@your-droplet-ip

# Update site (after making changes)
cd /var/www/campaign-site
git pull
npm ci
npm run generate
sudo systemctl reload nginx

# Or use the deployment script
/home/deploy-user/deploy.sh

# Check Nginx status
sudo systemctl status nginx

# View Nginx logs
sudo tail -f /var/log/nginx/access.log
sudo tail -f /var/log/nginx/error.log

# Test Nginx configuration
sudo nginx -t

# Reload Nginx after config changes
sudo systemctl reload nginx
```

## Troubleshooting

**Issue: 403 Forbidden**
- Check file permissions: `ls -la /var/www/campaign-site/.output/public`
- Fix permissions: `chmod -R 755 /var/www/campaign-site/.output/public`
- Check Nginx user: `ps aux | grep nginx` (usually www-data)
- Ensure files are owned by correct user: `chown -R deploy-user:www-data /var/www/campaign-site/.output/public`

**Issue: 404 Not Found**
- Verify root path in Nginx config: `root /var/www/campaign-site/.output/public;`
- Check if .output/public/ exists: `ls -la /var/www/campaign-site/.output/public`
- Rebuild site: `cd /var/www/campaign-site && npm run generate`

**Issue: Site not loading after deployment**
- Check Nginx error logs: `sudo tail -f /var/log/nginx/error.log`
- Verify build completed successfully
- Check that git pull fetched the latest changes

**Issue: Styles/scripts not loading**
- Verify _nuxt/ directory exists in .output/public/
- Check for CORS issues (unlikely for static site)
- Clear browser cache
